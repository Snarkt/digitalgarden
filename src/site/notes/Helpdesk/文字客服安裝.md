---
{"dg-publish":true,"permalink":"/helpdesk//"}
---


此篇使用 Helpdesk4J-2.1.1   
   
顯示今天修改過的檔案   
`find /SRM/Helpdesk4J/ -type f -mtime 0`   
   
關閉防火牆 disable<span style="color: red">d</span>
`vi /etc/sysconfig/selinux`   
`SELINUX=disabled`   
`systemctl disable firewalld.service`   
![image_u.png](/img/user/img/image_u.png)  
重新啟動，ssh會需要重連   
`reboot`   
   
創建 /SRM/Helpdesk4J 資料夾   
`mkdir -p /SRM/Helpdesk4J`   
![image_m.png](/img/user/img/image_m.png)

安裝unzip解壓縮
`sudo yum install unzip`  

`unzip AppData.zip -d AppData`   

解壓縮 tomcat
`tar -xzvf apache-tomcat-10.1.34.tar.gz`   
`mv apache-tomcat-10.1.34 tomcat9`

解壓縮 jdk
	1. jdk
	`tar -xzvf openlogic-openjdk-8u442-b06-linux-x64.tar.gz`
	`mv openlogic-openjdk-8u442-b06-linux-x64 openjdk`   
	2. jre
	`tar -xzvf openlogic-openjdk-jre-8u432-b06-linux-x64.tar.gz`
	`mv openlogic-openjdk-jre-8u432-b06-linux-x64 openjdk/jre`   

解壓縮 war 檔到 tomcat 底下
`cp Webhook.war Helpdesk4J.war tomcat9/webapps/`   

記得留著 war檔
`unzip Helpdesk4J.war -d Helpdesk4J`   
`unzip Webhook.war -d Webhook`   
   
解壓縮錯的話，指定檔案以外全部刪除   
`rm -rf !(Helpdesk4J.war\|Webhook.war)`   

安裝MariaDB   
`yum install mariadb-server.x86_64`   
`systemctl start mariadb`   
`systemctl enable mariadb`   
```
#密碼 password
mysql -u root -p

#建立資料庫
create database Helpdesk4J default character set utf8mb4 default collate utf8mb4_general_ci;
show databases;

#刪除資料庫
drop database Helpdesk4J
```
無法透過hibernate創建結構時可能需要用DB工具重新建立  

設定DB遠端連線 
加密密碼   
`set password=PASSWORD('password');`

MariaDB為了提高安全性，默認只監聽127.0.0.1的3306 port 並禁止TCP連線   
`select user,host from mysql.user;`   
查看Host為localhost   
![image_z 1.png](/img/user/img/image_z%201.png)
[為 MariaDB 配置遠端存取權限](https://blog.csdn.net/lanuage/article/details/78846766)   
%代表所有IP，password表示將用這個密碼登入root用戶   
`*.*` 記得別漏掉   
`GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'password' WITH GRANT OPTION;`   
   
指定IP連線   
VM   
`GRANT ALL PRIVILEGES ON *.* TO 'root'@'192.168.182.138' IDENTIFIED BY 'password' WITH GRANT OPTION;`   
主機   
`GRANT ALL PRIVILEGES ON *.* TO 'root'@'192.168.182.1' IDENTIFIED BY 'password' WITH GRANT OPTION;`   
   
刪除使用者   
`DROP USER'root'@'192.168.182.1';`   
`FLUSH PRIVILEGES;`   
   
保存更改   
`FLUSH PRIVILEGES;`   
`select user,host from mysql.user;`   


安裝 RabbitMQ   
RabbitMQ由erlang語言開發，需要安裝erlang環境   
下面網址為RabbitMQ對應erlang版本支持表   
[https://www.rabbitmq.com/docs/which-erlang](https://www.rabbitmq.com/docs/which-erlang)    
此篇 centos stream 9 安裝對應 RabbitMQ 3.13.7 erlang 26.2   
   
rpm安裝erlang   
   
查看所有版本   
[https://packagecloud.io/rabbitmq/erlang](https://packagecloud.io/rabbitmq/erlang)    
centos stream 10 沒有支援，所以重新安裝了centos stream 9   
版本中el7 el8 el9說明   
el7 是Red Hat 7.x、CentOS 7.x的縮寫   
el8 是Red Hat 8.x、CentOS 8.x的縮寫   
el9 是Red Hat 9.x、CentOS 9.x的縮寫   
   
查詢26.2 el/9   
安裝 erlang-26.2.5.4-1.el9.x86_64.rpm   
[https://packagecloud.io/rabbitmq/erlang/packages/el/9/erlang-26.2.5.4-1.el9.x86_64.rpm?distro_version_id=240](https://packagecloud.io/rabbitmq/erlang/packages/el/9/erlang-26.2.5.4-1.el9.x86_64.rpm?distro_version_id=240)    
   
```
curl -s https://packagecloud.io/install/repositories/rabbitmq/erlang/script.rpm.sh | sudo bash
```
   
```
sudo yum install erlang-26.2.5.4-1.el9.x86_64
```
   
rpm安裝rabbitmq   
   
查看所有版本   
[https://packagecloud.io/rabbitmq/rabbitmq-server](https://packagecloud.io/rabbitmq/rabbitmq-server)   
   
對照版本表，選擇3.13.7 el/9   
[https://www.rabbitmq.com/docs/which-erlang](https://www.rabbitmq.com/docs/which-erlang)   
   
跟el/8同個rpm   
rabbitmq-server-3.13.7-1.el8.noarch.rpm   
[https://packagecloud.io/rabbitmq/rabbitmq-server/packages/el/9/rabbitmq-server-3.13.7-1.el8.noarch.rpm?distro_version_id=240](https://packagecloud.io/rabbitmq/rabbitmq-server/packages/el/9/rabbitmq-server-3.13.7-1.el8.noarch.rpm?distro_version_id=240)    
   
```
curl -s https://packagecloud.io/install/repositories/rabbitmq/rabbitmq-server/script.rpm.sh | sudo bash
```
   
```
sudo yum install rabbitmq-server-3.13.7-1.el8.noarch
```
   
啟動 rabbitmq，沒有啟動文客會無法開啟
`sudo systemctl start rabbitmq-server.service` 
`sudo systemctl enable rabbitmq-server.service`
`sudo systemctl status rabbitmq-server.service`

啟動時連線異常，需要開啟rabbitmq的stomp 
cd /tmp/

安裝php   
`sudo dnf install -y php php-cli php-json php-zip php-common`

安裝composer   
`sudo curl -sS https://getcomposer.org/installer | sudo php`   
將composer安裝移動到系統路徑   
`sudo mv composer.phar /usr/local/bin/composer`

Composer 安装 webman/stomp 包   
`composer require webman/stomp`

啟用 RabbitMQ STOMP 插件   
`rabbitmq-plugins enable rabbitmq_stomp`


修改文字客服設定檔   
`cd /SRM/Helpdesk4J/AppData/cfg`   
`cp Server.properties.default Server.properties`   
`vim Server.properties`   
   
設定使用的DB   
`db.vendor = maria`
`db.url = jdbc:mysql://192.168.182.138:3306/Helpdesk4J`
`db.driver = org.mariadb.jdbc.Driver` 
   
DB的帳號密碼   
`db.cp = HikariCP`
`db.user = root`
`db.pw = password` 
   
第一次創建資料庫時使用 create，之後使用update   
`hibernate.hbm2ddl = create`   
   
修改Helpdesk4J的網址   
`hd4j.context.url = http://192.168.182.138:8082`
`hd4j.context.root = /Helpdesk4J/`   
   
修改Webhook的網址   
`webhook.context.url = http://192.168.182.138:8082
`webhook.context.root = /Webhook/` 

RabbitMQ 的預設帳號和密碼如下：
使用者名稱：guest
密碼：guest

STOMP port
rabbit.stomp.port = 61613
rabbit.username = guest
rabbit.password = guest

修改設定成Real 
`#Robot Sector：目前支援三種type，Real / Fake / NoOp` 
`#Real：與真的Robot串接，啟動之後自行到來源設定裡面填寫API key`
`#Fake：自帶假的Robot，只會複讀客戶說的話，只為了開發與測試用` 
`#NoOp：進線直接轉真人`
robot.type = <span style="color: red">Real</span>

修改tomcat port號
[Tomcat端口配置（详细）-CSDN博客](https://blog.csdn.net/weixin_69553582/article/details/124893517)   
`vim /SRM/Helpdesk4J/tomcat9/conf/server.xml`   
```
<Connector port="8082" protocol="HTTP/1.1"
           URIEncoding="UTF-8"
           connectionTimeout="20000"
           redirectPort="8443"/>
```

修改跟SmartRobot衝突的shutdown port 改成8006
```
<!-- SmartRobot -->
<Server port="8005" shutdown="SHUTDOWN">

<!-- helpdesk -->
<Server port="8006" shutdown="SHUTDOWN">
```

砍掉先前tomcat的port 8080   
`ps aux \| grep tomcat`   
`lsof -i :8080`   
`netstat -tuln \| grep 8080`   
`kill -9 [PID]`   

更改 /SRM/ 權限   
`chmod 755 /SRM/ -R`   

更改Startup.sh檔
`cd /SRM/Helpdesk4J`
`vim ./bin/Startup.sh`   
```
#!/bin/bash
export JAVA_HOME=/SRM/Helpdesk4J/openjdk
export JRE_HOME=$JAVA_HOME/jre
export PATH=$JAVA_HOME/bin:$PATH
export CATALINA_HOME=/SRM/Helpdesk4J/tomcat9
export CATALIAN_PID=catalinaPid
export JAVA_OPTS="${JAVA_OPTS} -DappData=/SRM/Helpdesk4J/AppData -Xmx1562M -Xms512M -XX:MetaspaceSize=256M -Djava.util.logging.config.file=${CATALINA_HOME}/conf/logging.properties"
${CATALINA_HOME}/bin/startup.sh
```
 
記得啟動 rabbitmq，沒有啟動文客會無法開啟   
`sudo systemctl enable rabbitmq-server.service`
啟用 RabbitMQ STOMP 插件
`rabbitmq-plugins enable rabbitmq_stomp`

執行Helpdesk4J   
`cd /SRM/Helpdesk4J`   
`./bin/Startup.sh`   
![image_e 1.png](/img/user/img/image_e%201.png)
查看tomcat log服務是否正常   
`less /SRM/Helpdesk4J/tomcat9/logs/catalina.out`   
![image_d 1.png](/img/user/img/image_d%201.png)
   
全部步驟順利的話~成功啟動   
http://192.168.182.138:8082/Helpdesk4J/login   
![image_s 1.png](/img/user/img/image_s%201.png)

第一次創建資料庫時使用 create，之後使用update
`vim /SRM/Helpdesk4J/AppData/cfg/Server.properties`
`hibernate.hbm2ddl = update`

登入帳號密碼，驚嘆號記得打   
admin   
intumit!!   
http://192.168.182.138:8082/Webhook/    

文字客服串接robot   
   
因為admin能操作的權限只有新增使用者   
![image_r 1.png](/img/user/img/image_r%201.png)
需要添加一位全開權限   
aa
aa@a.a
- [ ] 啟用
權限角色
- [ ] 系統管理者
- [ ] 客服
- [ ] 監控
- [ ] 報表
12345678   

登入之後設定>來源設定   
新增智能客服網址   
http://192.168.182.138:8081/
![image_1 1.png](/img/user/img/image_1%201.png) 
   
填入API key設定啟用   
![image_4 1.png](/img/user/img/image_4%201.png)

來源設定如下
![Pasted image 20250207164922.png](/img/user/img/Pasted%20image%2020250207164922.png)

最後成功串接   
![image 1.png](/img/user/img/image%201.png)    

重開helpdesk的Webhook，SmartRobot也會出現紀錄
![image_13.png](/img/user/img/image_13.png)

helpdesk轉真人客服

SmartRobot添加文字客服網址
![Pasted image 20250207170943.png](/img/user/img/Pasted%20image%2020250207170943.png)

添加技能
test
shift向下全選
分配使用者給aa
![Pasted image 20250207164735.png](/img/user/img/Pasted%20image%2020250207164735.png)

來源設定添加技能
![Pasted image 20250207164922.png](/img/user/img/Pasted%20image%2020250207164922.png)

更改設定檔
vim /SRM/SmartRobot/kernel/etc/application.properties
```
spring.main.allow-circular-references=true
spring.main.allow-bean-definition-overriding=true
spring.servlet.multipart.max-file-size=30MB
spring.servlet.multipart.max-request-size=100MB
semanticsearch.redis.host=localhost
semanticsearch.redis.port=6379
semanticsearch.redis.password=redispw
semanticsearch.redis.pool.max-active=10
semanticsearch.redis.pool.max-idle=5
semanticsearch.redis.pool.min-idle=1
semanticsearch.redis.use-ssl=false
semanticsearch.azure.ai.search.endpoint=https://serviceName.search.windows.net
semanticsearch.azure.ai.search.key=azuresearchkey
# Server
# server.port=8080

system.robotBackendTitle=
system.robotBackendIcon=
system.tenantBackendTitle=
system.tenantBackendIcon=
# 原 system.properties 內容，移至這裡並將 key 去底線改首字大寫
system.aesSecPwdKey=Intumit168168168
system.aesInitVector=IntumitRandomInV
system.desEncryption=uehfr2ic
system.desSpec=g93cn72k
system.sessionKey=INTUMITTENANT
system.fileMaxSize=-1
system.logPath=/SRM/SmartRobot/jetty9/logs/
# WEB(文字客服前台 or Gateway)
system.webApiHttpRequestProxy=/gateway/httpRequestProxy
system.webUrlRedirectPage=/redirect/page
# 是否要提供 SmartBERT 相關設定（預設關閉）
system.enableSmartBert=false
# 關鍵字自動回覆（屬於 BC 功能，預設關閉）
system.enableAutoReply=false
# Robot 內建文服（目前預設都是關閉）
system.enableLiveAgent=false
# Solr 同步功能（預設關閉）
system.enableSolrSync=false
# 行銷活動壓測模式，跳過檢查idToken的流程(屬於 BC 功能，預設關閉)
system.enableStressTestingMode=false
# 向量查詢類型 (AzureVector / RedisVector 則一)
system.vectorServiceType=RedisVector
system.enableGallery=false
system.galleryRemoteUrl=http://127.0.0.1:8080/wise

azure.aad.authority=https://login.microsoftonline.com/${Tenant ID}/
azure.aad.clientId=
azure.aad.clientSecret=
```

添加有效的License key   
vim /SRM/Helpdesk4J/AppData/license/license.xml   
```
<?xml version="1.0" encoding="UTF-8"?><Helpdesk4J-License>
    <客戶名稱>LHC01D181 碩網資訊股份有限公司 產品開發</客戶名稱>
    <同時上線人數>15</同時上線人數>
    <有效期限>2032-12-31</有效期限>
    <是否串接SmartRobot>true</是否串接SmartRobot>
<Signature xmlns="http://www.w3.org/2000/09/xmldsig#"><SignedInfo><CanonicalizationMethod Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/><SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"/><Reference URI=""><Transforms><Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/></Transforms><DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/><DigestValue>3JO83srJ3CDqtg3p/hHpQWe5FIk=</DigestValue></Reference></SignedInfo><SignatureValue>OBf2lpo3V/P2Q2YCEQo5VZyfk6KKAHZvudnPPIjjLAPSuOsS/yl2aSAuvlrJl67+w+JMifVG6+8R
tnMmjM2XpkbSGRdceP4CUqGkFxstYUQR3YlBcRdRN/1bflYmzu4nsQOTFYK3HcrBC7cSrkbLU0Ie
LpyfwbpWnSAC4yqn3B0=</SignatureValue><KeyInfo><KeyValue><RSAKeyValue><Modulus>+Zs6csQLLJCU4Cuasrh3i8tBvy8Oglsx1sk5aO81gCEydryLfR5gGUtdsftMPJt6JogacM1UINdL
5IOpgJUm+sfyyg1hsLWMmsW6+JHPmqIrt+/jURB+87en+HCipq4ucEg1O6P9xeBTNH9naEW0q8Q9
ZgcZDuaAFGW0xBkhDS0=</Modulus><Exponent>AQAB</Exponent></RSAKeyValue></KeyValue></KeyInfo></Signature></Helpdesk4J-License>
```    

![image_x 1.png](/img/user/img/image_x%201.png)

狀態切換為上線
![Pasted image 20250207165652.png](/img/user/img/Pasted%20image%2020250207165652.png)

![Pasted image 20250207170219.png](/img/user/img/Pasted%20image%2020250207170219.png)
![Pasted image 20250207170231.png](/img/user/img/Pasted%20image%2020250207170231.png)
![Pasted image 20250207170244.png](/img/user/img/Pasted%20image%2020250207170244.png)
![Pasted image 20250207170300.png](/img/user/img/Pasted%20image%2020250207170300.png)
